<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- æ·»åŠ ç§»åŠ¨ç«¯è§†å£é…ç½® -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”å¹´3ç­å­¦ç”Ÿç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <!-- æ·»åŠ  SheetJS åº“ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- æ·»åŠ  QRCode.js åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;             /* æ”¹å˜èƒŒæ™¯è‰² */
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);  /* 6åˆ—ç­‰å®½ */
            gap: 20px;                              /* å¢åŠ é—´è· */
            margin: 20px auto;
            padding: 15px;                          /* æ·»åŠ å†…è¾¹è· */
            max-width: 1600px;                      /* é™åˆ¶æœ€å¤§å®½åº¦ */
        }
        .student-card {
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 10px;
            background-color: #fff;                 /* ä½¿ç”¨çº¯ç™½èƒŒæ™¯ */
            min-height: 140px; /* å‡å°å¡ç‰‡é«˜åº¦ä½¿ä¸€é¡µèƒ½æ˜¾ç¤º6è¡Œ */
            width: 100%;     /* ç¡®ä¿å¡ç‰‡å æ»¡ç½‘æ ¼å•å…ƒæ ¼ */
            box-sizing: border-box;  /* åŒ…å«paddingå’Œborderåœ¨å†…çš„æ€»å®½åº¦ */
            min-width: 240px; /* ç¡®ä¿æœ€å°å®½åº¦ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* æ·»åŠ é˜´å½±æ•ˆæœ */
            transition: all 0.3s ease;              /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
            position: relative;
        }
        .student-card:hover {
            transform: translateY(-2px);            /* æ‚¬åœæ—¶è½»å¾®ä¸Šæµ® */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .score-input {
            width: 60px;
            margin: 5px 0;
            padding: 3px;
        }
        .button-group {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        button {
            cursor: pointer;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            transition: 0.3s;
        }
        .add-btn {
            background-color: #4CAF50;
            color: white;
        }
        .subtract-btn {
            background-color: #f44336;
            color: white;
        }
        button:hover {
            opacity: 0.8;
        }
        .total-score {
            font-weight: bold;
            color: #2196F3;
            margin: 0;  /* ç§»é™¤åŸæœ‰è¾¹è· */
            border-bottom: 1px solid #e0e0e0;  /* æ·»åŠ åˆ†éš”çº¿ */
            padding-bottom: 3px;  /* åˆ†éš”çº¿ä¸æ–‡å­—çš„é—´è· */
        }
        .controls {
            margin: 20px 0;
        }
        .reset-btn {
            background-color: #ff9800;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }
        .sort-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
        }
        .student-name {
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            word-break: break-all;  /* å…è®¸é•¿æ–‡æœ¬åœ¨ä»»æ„å­—ç¬¦å¤„æ¢è¡Œ */
            min-height: 24px;      /* ç¡®ä¿åå­—åŒºåŸŸé«˜åº¦ä¸€è‡´ */
        }
        .student-name:hover {
            background-color: #e0e0e0;
        }
        .clear-storage-btn {
            background-color: #9c27b0;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }
        .student-number {
            color: #666;
            margin-right: 5px;
        }
        .history-log {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .export-btn, .import-btn, .restore-order-btn {
            background-color: #607d8b;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
        }
        .history-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        
        /* æ·»åŠ å†å²è®°å½•æŒ‰é’®å’Œå¼¹çª—æ ·å¼ */
        .history-btn {
            background-color: #795548;
            color: white;
            font-size: 12px;
            margin-top: 5px;
            width: 100%;
        }
        
        .history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .history-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .score-display {
            display: flex;
            flex-direction: column;  /* æ”¹ä¸ºçºµå‘æ’åˆ— */
            margin: 5px 0;
        }
        .score-symbol {
            display: grid;
            grid-template-columns: repeat(10, 18px); /* ç¨å¾®å‡å°ç¬¦å·å¤§å° */
            gap: 1px;
            margin-top: 2px;
            min-height: 30px;
            font-size: 12px;
            justify-content: center;
        }
        .star, .moon, .sun {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 18px;
            height: 18px;
            font-size: 14px;
        }

        /* ä¿®æ”¹æ’è¡Œæ¦œæ ·å¼ */
        .leaderboard {
            position: fixed;
            left: 20px;           /* æ”¹å›å·¦ä¾§å®šä½ */
            right: auto;          /* ç§»é™¤å³ä¾§å®šä½ */
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            background: #fff;
            border: 2px solid gold;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .leaderboard-title {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .rank-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 5px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .rank-number {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            border-radius: 50%;
            font-weight: bold;
        }
        
        .rank-1 .rank-number { 
            background: gold;
            color: #fff;
        }
        .rank-1 .rank-crown {
            color: gold;
            margin-left: 5px;
        }
        
        .rank-2 .rank-number {
            background: silver;
            color: #fff;
        }
        .rank-2 .rank-crown {
            color: silver;
            margin-left: 5px;
        }
        
        .rank-3 .rank-number {
            background: #cd7f32;
            color: #fff;
        }
        .rank-3 .rank-crown {
            color: #cd7f32;
            margin-left: 5px;
        }
        
        .rank-4 .rank-number,
        .rank-5 .rank-number {
            background: #808080;
            color: #fff;
        }
        
        .rank-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .rank-score {
            margin-left: 10px;
            color: #2196F3;
            font-weight: bold;
        }

        /* ä¿®æ”¹ä¸»å†…å®¹åŒºåŸŸå¸ƒå±€ */
        .main-content {
            margin-left: 240px; /* æ”¹å›å·¦è¾¹è· */
            margin-right: 0;    /* ç§»é™¤å³è¾¹è· */
        }
        .sun {
            color: #FFD700;
            font-size: 18px;
        }
        .moon {
            color: #7986CB;
            font-size: 16px;
        }
        .star {
            color: #FFD700;
            font-size: 16px;
        }
        /* è°ƒæ•´æ ‡é¢˜åŒºåŸŸæ ·å¼ */
        h2 {
            margin-top: 0;        /* ç§»é™¤é¡¶éƒ¨è¾¹è· */
            padding-top: 20px;    /* æ·»åŠ é¡¶éƒ¨å†…è¾¹è· */
        }
        .lock-btn {
            background-color: #FF5722;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }
        
        .lock-btn.locked {
            background-color: #607D8B;
        }

        /* ç¦ç”¨çŠ¶æ€æ ·å¼ */
        .disabled {
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* æ·»åŠ å¯†ç å¼¹çª—æ ·å¼ */
        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            width: 300px;
        }

        .password-input {
            width: 100%;
            padding: 10px;
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            border-color: #2196F3;
        }

        .password-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .password-btn {
            padding: 8px 20px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .password-submit {
            background-color: #4CAF50;
            color: white;
        }

        .password-cancel {
            background-color: #f44336;
            color: white;
        }

        .password-title {
            color: #333;
            margin: 0 0 20px 0;
            font-size: 18px;
        }

        /* ç»Ÿä¸€å¼¹çª—æ ·å¼ */
        .modal-base {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content-base {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            width: 300px;
            position: relative;
        }

        .modal-title {
            color: #333;
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
        }

        .modal-btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .modal-btn-secondary {
            background-color: #f44336;
            color: white;
        }

        .modal-content {
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        /* æ·»åŠ è¾“å…¥æ¡†æ ·å¼ */
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .modal-input:focus {
            border-color: #2196F3;
        }

        /* ä¿®æ”¹å†å²è®°å½•å†…å®¹æ ·å¼ */
        .history-item {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            margin: 5px 0;
        }

        /* æ·»åŠ ç§¯åˆ†åŒºé—´é¢œè‰²æ ·å¼ */
        .score-0-100 {
            color: #2196F3;  /* è“è‰² */
        }
        
        .score-100-500 {
            color: #FF9800;  /* æ©™è‰² */
        }
        
        .score-500-1000 {
            color: #F44336;  /* çº¢è‰² */
        }

        /* æ·»åŠ å“åº”å¼å¸ƒå±€æ ·å¼ */
        @media screen and (max-width: 1024px) {
            .student-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
                padding: 10px;
            }

            .main-content {
                margin-left: 0;  /* ç§»åŠ¨ç«¯ç§»é™¤å·¦è¾¹è· */
            }

            .leaderboard {
                display: none; /* éšè—å›ºå®šæ’è¡Œæ¦œ */
            }

            /* æ·»åŠ ç§»åŠ¨ç«¯æ’è¡Œæ¦œæ ·å¼ */
            .mobile-leaderboard {
                display: block;
                margin: 20px 0;
                background: #fff;
                border: 2px solid gold;
                border-radius: 10px;
                padding: 15px;
            }
        }

        @media screen and (max-width: 768px) {
            .student-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .controls button {
                flex: 1;
                min-width: 150px;
                margin: 0;
            }

            body {
                padding: 10px;
            }

            .modal-content-base {
                width: 90%;
                margin: 0 15px;
            }
        }

        @media screen and (max-width: 480px) {
            .student-grid {
                grid-template-columns: 1fr;
            }

            .student-card {
                min-width: unset;
            }

            h2 {
                font-size: 18px;
            }

            .controls button {
                padding: 6px 12px;
                font-size: 14px;
                min-width: unset;
            }
        }

        /* æ·»åŠ è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) {
            .student-card:hover {
                transform: none;
            }

            button {
                padding: 8px 16px; /* å¢å¤§æŒ‰é’®ç‚¹å‡»åŒºåŸŸ */
            }

            .student-name {
                padding: 6px;  /* å¢å¤§åå­—ç‚¹å‡»åŒºåŸŸ */
            }
        }

        /* ä¿®æ”¹æ’è¡Œæ¦œæ˜¾ç¤ºé€»è¾‘ */
        .mobile-leaderboard {
            display: none;
        }

        @media screen and (min-width: 1025px) {
            .mobile-leaderboard {
                display: none;
            }
            .leaderboard {
                display: block;
            }
        }

        /* æ·»åŠ äºŒç»´ç æŒ‰é’®å’Œå¼¹çª—æ ·å¼ */
        .qr-btn {
            background-color: #9C27B0;
            color: white;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        
        .qr-modal .modal-content-base {
            width: 300px;
            padding: 20px;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 15px 0;
        }
        
        .qr-instructions {
            font-size: 14px;
            color: #666;
            margin-top: 15px;
            text-align: center;
        }

        @media screen and (max-width: 768px) {
            .qr-btn {
                display: none; /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šéšè—äºŒç»´ç æŒ‰é’® */
            }
        }

        /* æ·»åŠ ä¿®æ”¹å¯†ç æŒ‰é’®æ ·å¼ */
        .change-password-btn {
            background-color: #673AB7;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }

        /* æ·»åŠ ç³»ç»Ÿæç¤ºå¼¹çª—ç‰¹æ®Šæ ·å¼ */
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
        }

        .system-alert .modal-content-base {
            border-left: 5px solid #4CAF50;
            max-width: 400px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .system-alert.warning .modal-content-base {
            border-left: 5px solid #ff9800;
        }

        .system-alert .modal-title {
            color: #4CAF50;
            font-size: 20px;
            margin-bottom: 15px;
            width: 100%;
            text-align: center;
        }

        .system-alert.warning .modal-title {
            color: #ff9800;
        }

        .system-alert .modal-content {
            font-size: 16px;
            padding: 10px;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            word-wrap: break-word;
        }

        .system-alert .modal-close {
            position: absolute;
            right: 10px;
            top: 10px;
        }

        /* æ·»åŠ æ–°å¢å­¦ç”Ÿå¡ç‰‡æ ·å¼ */
        .add-student-card {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-student-card:hover {
            background-color: #e0e0e0;
        }

        .add-icon {
            font-size: 40px;
            color: #666;
        }

        /* æ·»åŠ åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-student-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background-color: #f44336;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .student-card:hover .delete-student-btn {
            opacity: 1;
        }

        .admin-btn {
            background-color: #673AB7;
            color: white;
            padding: 8px 16px;
            margin-right: 10px;
        }

        .admin-only {
            display: none;  /* é»˜è®¤éšè—ç®¡ç†å‘˜åŠŸèƒ½ */
        }

        .admin-mode .admin-only {
            display: inline-block;  /* ç®¡ç†å‘˜æ¨¡å¼ä¸‹æ˜¾ç¤º */
        }

        /* æ·»åŠ ç®¡ç†å‘˜æ¨¡å¼ä¸‹çš„åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-student-btn {
            display: none; /* é»˜è®¤éšè—åˆ é™¤æŒ‰é’® */
        }
        
        .admin-mode .delete-student-btn {
            display: flex; /* ç®¡ç†å‘˜æ¨¡å¼ä¸‹æ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        }
        
        /* æ·»åŠ å¡ç‰‡åœ¨éç®¡ç†å‘˜æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .add-student-card {
            display: none; /* é»˜è®¤éšè—æ·»åŠ å¡ç‰‡ */
        }
        
        .admin-mode .add-student-card {
            display: flex; /* ç®¡ç†å‘˜æ¨¡å¼ä¸‹æ˜¾ç¤ºæ·»åŠ å¡ç‰‡ */
        }
    </style>
</head>
<body>
    <!-- åœ¨ main-content div ä¹‹å‰æ·»åŠ ç§»åŠ¨ç«¯æ’è¡Œæ¦œ -->
    <div class="mobile-leaderboard">
        <div class="leaderboard-title">ç§¯åˆ†æ’è¡Œæ¦œ</div>
        <div id="mobileRankingList"></div>
    </div>

    <!-- ä¿®æ”¹ä¸»è¦å†…å®¹çš„åŒ…è£…å™¨ -->
    <div class="main-content">
        <h2>äº”å¹´3ç­å­¦ç”Ÿç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h2>
        
        <div class="controls">
            <button class="admin-btn" onclick="toggleAdmin()">ç®¡ç†å‘˜ç™»å½•</button>
            <button class="change-password-btn admin-only" onclick="handleChangePassword()">ä¿®æ”¹å¯†ç </button>
            <button class="clear-storage-btn admin-only" onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <button class="reset-btn admin-only" onclick="resetAllScores()">é‡ç½®æ‰€æœ‰ç§¯åˆ†</button>
            <button class="sort-btn" onclick="sortStudents()">æŒ‰ç§¯åˆ†æ’åº</button>
            <button class="restore-order-btn" onclick="restoreOriginalOrder()">æ¢å¤é»˜è®¤æ’åº</button>
            <button class="export-btn admin-only" onclick="exportToExcel()">å¯¼å‡ºåˆ°Excel</button>
            <button class="import-btn admin-only" onclick="importFromExcel()">ä»Excelå¯¼å…¥</button>
        </div>
        
        <div class="student-grid" id="studentContainer"></div>
    </div>

    <!-- æ·»åŠ æ’è¡Œæ¦œ -->
    <div class="leaderboard">
        <div class="leaderboard-title">ç§¯åˆ†æ’è¡Œæ¦œ</div>
        <div id="rankingList"></div>
    </div>

    <!-- ä¿®æ”¹å†å²è®°å½•å¼¹çª—HTMLç»“æ„ -->
    <div class="modal-base" id="historyModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeHistoryModal()">&times;</span>
            <h3 class="modal-title" id="historyTitle">ç§¯åˆ†å†å²è®°å½•</h3>
            <div class="modal-content" id="historyContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="closeHistoryModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å§“åç¼–è¾‘å¼¹çª— -->
    <div class="modal-base" id="nameEditModal">
        <div class="modal-content-base">
            <h3 class="modal-title">ä¿®æ”¹å§“å</h3>
            <div class="modal-content"></div>
                <input type="text" class="modal-input" id="nameInput" placeholder="è¯·è¾“å…¥æ–°çš„å§“å">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="submitNameEdit()">ç¡®å®š</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeNameEditModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¯†ç å¼¹çª—HTML -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <h3 class="password-title">è¯·è¾“å…¥è§£é”å¯†ç </h3>
            <input type="password" class="password-input" id="passwordInput" placeholder="è¯·è¾“å…¥å¯†ç ">
            <div class="password-buttons">
                <button class="password-btn password-submit" onclick="submitPassword()">ç¡®è®¤</button>
                <button class="password-btn password-cancel" onclick="closePasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç³»ç»Ÿæç¤ºå¼¹çª—çš„HTMLç»“æ„ -->
    <div class="modal-base system-alert" id="alertModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeAlertModal()">&times;</span>
            <h3 class="modal-title">ç³»ç»Ÿæç¤º</h3>
            <div class="modal-content" id="alertContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="closeAlertModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç¡®è®¤å¼¹çª— -->
    <div class="modal-base" id="confirmModal">
        <div class="modal-content-base">
            <h3 class="modal-title">ç¡®è®¤</h3>
            <div class="modal-content" id="confirmContent"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="handleConfirm(true)">ç¡®å®š</button>
                <button class="modal-btn modal-btn-secondary" onclick="handleConfirm(false)">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ äºŒç»´ç æŒ‰é’® -->
    <button class="qr-btn" onclick="showQRCode()">
        <span style="font-size: 24px;">ğŸ“±</span>
    </button>

    <!-- æ·»åŠ äºŒç»´ç å¼¹çª— -->
    <div class="modal-base qr-modal" id="qrModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeQRModal()">&times;</span>
            <h3 class="modal-title">æ‰‹æœºæ‰«ç è®¿é—®</h3>
            <div id="qrcode"></div>
            <div class="qr-instructions">
                ä½¿ç”¨æ‰‹æœºç›¸æœºæ‰«æäºŒç»´ç å³å¯åœ¨æ‰‹æœºä¸Šè®¿é—®ç³»ç»Ÿ
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="closeQRModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ä¿®æ”¹å¯†ç å¼¹çª— -->
    <div class="modal-base" id="changePasswordModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeChangePasswordModal()">&times;</span>
            <h3 class="modal-title">ä¿®æ”¹å¯†ç </h3>
            <div class="modal-content">
                <input type="password" class="modal-input" id="oldPassword" placeholder="è¯·è¾“å…¥åŸå¯†ç ">
                <input type="password" class="modal-input" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                <input type="password" class="modal-input" id="confirmPassword" placeholder="è¯·ç¡®è®¤æ–°å¯†ç ">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="submitChangePassword()">ç¡®å®š</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeChangePasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ éªŒè¯å¯†ç å¼¹çª—åˆ° body ä¸­ -->
    <div class="modal-base" id="verifyPasswordModal">
        <div class="modal-content-base">
            <h3 class="modal-title">è¯·è¾“å…¥ç³»ç»Ÿå¯†ç </h3>
            <div class="modal-content">
                <input type="password" class="modal-input" id="verifyPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                <div class="qr-instructions" style="margin-bottom: 10px;">
                    <span id="verifyPasswordMessage"></span>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="submitVerifyPassword()">ç¡®è®¤</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeVerifyPasswordModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ æ–°å¢å­¦ç”Ÿå¼¹çª— -->
    <div class="modal-base" id="addStudentModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeAddStudentModal()">&times;</span>
            <h3 class="modal-title">æ–°å¢å­¦ç”Ÿ</h3>
            <div class="modal-content">
                <input type="text" class="modal-input" id="newStudentName" placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å">
                <div class="qr-instructions" style="color: #666;">
                    æç¤ºï¼šå§“åä¸­ä¸è¦åŒ…å«æ•°å­—ï¼Œåºå·ä¼šè‡ªåŠ¨ç”Ÿæˆ
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="submitAddStudent()">ç¡®å®š</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeAddStudentModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç®¡ç†å‘˜ç™»å½•å¼¹çª— -->
    <div class="modal-base" id="adminLoginModal">
        <div class="modal-content-base">
            <span class="modal-close" onclick="closeAdminLogin()">&times;</span>
            <h3 class="modal-title">ç®¡ç†å‘˜ç™»å½•</h3>
            <div class="modal-content">
                <input type="password" class="modal-input" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                <div class="qr-instructions" style="color: #666;">
                    åˆå§‹ç®¡ç†å‘˜å¯†ç ï¼šadmin888
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="submitAdminLogin()">ç™»å½•</button>
                <button class="modal-btn modal-btn-secondary" onclick="closeAdminLogin()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–å­¦ç”Ÿæ•°æ®
        const initializeStudents = () => {
            const students = JSON.parse(localStorage.getItem('students')) || [];
            if (students.length === 0) {
                const names = [
                    'è”¡ç…œå®‰', 'é™ˆæ³½å‹‹', 'é™ˆæ¢“è½©', 'æ´ªå¥åŸ', 'é»„é•“è‰º', 'æ±Ÿè‡»èƒ¤',
                    'ç»ƒé•¿é‘«', 'å»–æŸè¾°', 'æ—æ¢“ç¦', 'è‹ä¿Šæ•', 'å¼ ç…œé”‹', 'é™ˆç…Œä»ª',
                    'ç‹ç’Ÿé€¸', 'å¼ ç€šçª', 'æ—ç¦¹è¡¡', 'ç‹èŒæº', 'é»„è“¥èŠ¯', 'æ¨å­å¦',
                    'æ›¾é›…ç³', 'è‹æ©æ€¡', 'ç‹å¸Œæ©', 'å§šåº„è¯š', 'å¼ å®‡å½¤', 'æå˜‰å‹‹',
                    'æ—å‡¯æ¥ ', 'é™ˆç¥é¢–', 'è´¹å¥•æ–‡', 'æ¢ä¸–å¼˜', 'å•ç´«ç¿”', 'æç§‹å',
                    'è®¸å®ä¼Ÿ', 'é™ˆæ–‡é“„', 'èµµæ¢“è¨€', 'è‹ç‘¾è±', 'é™ˆå˜‰ä¿Š', 'éƒ‘æ²›æ–‡'
                ];
                names.forEach((name, index) => {
                    students.push({
                        id: index + 1,
                        name: name,
                        score: 0
                    });
                });
                localStorage.setItem('students', JSON.stringify(students));
            }
            return students;
        };

        // æ›´æ–°åˆ†æ•°
        window.updateScore = (studentId, operation) => {
            const input = document.getElementById(`input-${studentId}`);
            const value = parseInt(input.value);
            
            if (isNaN(value) || value <= 0) {
                showAlert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•´æ•°å€¼");
                return;
            }

            const students = JSON.parse(localStorage.getItem('students'));
            const student = students.find(s => s.id === studentId);
            const oldScore = student.score;
            
            if (operation === 'add') {
                student.score += value;
            } else {
                student.score = Math.max(0, student.score - value);
            }
            
            addHistory(studentId, operation, value, oldScore, student.score);
            localStorage.setItem('students', JSON.stringify(students));
            updateDisplay(students);
            resetAdminTimer();
        };

        // ä¿®æ”¹ç¼–è¾‘å§“åå‡½æ•°
        window.editName = (studentId) => {
            if (!isAdmin) {
                showAlert('ä¿®æ”¹å§“åéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }
            
            checkLock(() => {
                const students = JSON.parse(localStorage.getItem('students'));
                const student = students.find(s => s.id === studentId);
                currentEditingId = studentId;
                
                const modal = document.getElementById('nameEditModal');
                const input = document.getElementById('nameInput');
                input.value = student.name.replace(/^\d+\./, ''); // ç§»é™¤ç°æœ‰åºå·
                modal.style.display = 'flex';
                input.focus();
                input.select();
                resetAdminTimer();  // é‡ç½®ç®¡ç†å‘˜è¶…æ—¶è®¡æ—¶å™¨
            });
        };

        function closeNameEditModal() {
            document.getElementById('nameEditModal').style.display = 'none';
            currentEditingId = null;
        }

        function submitNameEdit() {
            const newName = document.getElementById('nameInput').value.trim();
            if (!newName) {
                showAlert('å§“åä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            if (/\d/.test(newName)) {
                showAlert('å§“åä¸èƒ½åŒ…å«æ•°å­—ï¼');
                return;
            }

            if (currentEditingId) {
                const students = JSON.parse(localStorage.getItem('students'));
                const student = students.find(s => s.id === currentEditingId);
                const studentIndex = students.findIndex(s => s.id === currentEditingId);
                student.name = `${studentIndex + 1}.${newName}`;  // æ·»åŠ åºå·å‰ç¼€
                localStorage.setItem('students', JSON.stringify(students));
                updateDisplay(students);
                closeNameEditModal();
                showAlert('âœ… ä¿®æ”¹å§“åæˆåŠŸï¼');
            }
        }

        // æ·»åŠ å›è½¦é”®æäº¤å§“åä¿®æ”¹
        document.getElementById('nameInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitNameEdit();
            }
        });

        // ä¿®æ”¹æ¸…é™¤å­˜å‚¨å‡½æ•°
        window.clearStorage = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }
            
            showConfirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ¸…é™¤åå°†é‡æ–°åˆå§‹åŒ–å­¦ç”Ÿåå•', (result) => {
                if (result) {
                    localStorage.removeItem('students');
                    localStorage.removeItem('scoreHistory');
                    showAlert('âš ï¸ æ•°æ®å·²æ¸…é™¤ï¼Œç³»ç»Ÿå°†é‡æ–°åˆå§‹åŒ–', true);
                    setTimeout(() => location.reload(), 2000);
                }
            });
        };

        // ä¿®æ”¹é‡ç½®ç§¯åˆ†å‡½æ•°
        window.resetAllScores = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }

            showConfirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', (result) => {
                if (result) {
                    const students = JSON.parse(localStorage.getItem('students'));
                    const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];
                    
                    // è®°å½•é‡ç½®æ“ä½œåˆ°å†å²è®°å½•
                    students.forEach(student => {
                        if (student.score > 0) {
                            history.push({
                                studentId: student.id,
                                studentName: student.name,
                                operation: 'reset',
                                value: student.score,
                                oldScore: student.score,
                                newScore: 0,
                                timestamp: new Date().toLocaleString()
                            });
                            student.score = 0;
                        }
                    });
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    localStorage.setItem('scoreHistory', JSON.stringify(history));
                    updateDisplay(students);
                    showAlert('âœ… æ‰€æœ‰å­¦ç”Ÿç§¯åˆ†å·²é‡ç½®ä¸º0', false);
                }
            });
        };

        // æŒ‰ç§¯åˆ†æ’åº
        window.sortStudents = () => {
            const students = JSON.parse(localStorage.getItem('students'));
            students.sort((a, b) => b.score - a.score);
            updateDisplay(students);
        };

        // æ¢å¤é»˜è®¤æ’åº
        window.restoreOriginalOrder = () => {
            const students = JSON.parse(localStorage.getItem('students'));
            students.sort((a, b) => a.id - b.id);
            updateDisplay(students);
        };

        // å¯¼å‡ºåˆ°Excel
        window.exportToExcel = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            const students = JSON.parse(localStorage.getItem('students'));
            const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];

            // å‡†å¤‡å­¦ç”Ÿæ•°æ®å·¥ä½œè¡¨
            const studentData = students.map(s => ({
                'åºå·': s.id,
                'å§“å': s.name.replace(/^\d+\./, ''), // ç§»é™¤åºå·å‰ç¼€
                'ç§¯åˆ†': s.score
            }));

            // å‡†å¤‡å†å²è®°å½•å·¥ä½œè¡¨
            const historyData = history.map(h => ({
                'æ—¶é—´': h.timestamp,
                'å­¦ç”Ÿ': h.studentName.replace(/^\d+\./, ''),
                'æ“ä½œ': h.operation === 'add' ? 'åŠ åˆ†' : h.operation === 'subtract' ? 'å‡åˆ†' : 'é‡ç½®',
                'åˆ†å€¼': h.value,
                'å˜æ›´å‰ç§¯åˆ†': h.oldScore,
                'å˜æ›´åç§¯åˆ†': h.newScore
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // æ·»åŠ å­¦ç”Ÿæ•°æ®å·¥ä½œè¡¨
            const ws1 = XLSX.utils.json_to_sheet(studentData);
            XLSX.utils.book_append_sheet(wb, ws1, "å­¦ç”Ÿç§¯åˆ†");

            // æ·»åŠ å†å²è®°å½•å·¥ä½œè¡¨
            const ws2 = XLSX.utils.json_to_sheet(historyData);
            XLSX.utils.book_append_sheet(wb, ws2, "å†å²è®°å½•");

            // å¯¼å‡ºExcelæ–‡ä»¶
            XLSX.writeFile(wb, `ç§¯åˆ†æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        };

        // ä»Excelå¯¼å…¥
        window.importFromExcel = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // è¯»å–å­¦ç”Ÿæ•°æ®
                        const studentSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const studentData = XLSX.utils.sheet_to_json(studentSheet);
                        
                        // éªŒè¯åå­—æ ¼å¼
                        const invalidNames = studentData.filter(row => /\d/.test(row['å§“å']));
                        if (invalidNames.length > 0) {
                            showAlert('å¯¼å…¥å¤±è´¥ï¼šä»¥ä¸‹å­¦ç”Ÿå§“ååŒ…å«æ•°å­—ï¼š\n' + 
                                    invalidNames.map(row => row['å§“å']).join('\n'));
                            return;
                        }

                        // è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                        const students = studentData.map((row, index) => ({
                            id: index + 1,
                            name: `${index + 1}.${row['å§“å']}`,
                            score: parseInt(row['ç§¯åˆ†']) || 0
                        }));

                        // ä¿å­˜æ•°æ®
                        localStorage.setItem('students', JSON.stringify(students));
                        updateDisplay(students);
                        showAlert('âœ… å¯¼å…¥æˆåŠŸï¼');

                    } catch (err) {
                        console.error(err);
                        showAlert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        };

        // æ·»åŠ æ¸…é™¤å­˜å‚¨çš„å‡½æ•°
        window.clearStorage = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }
            
            const verifyAndClear = () => {
                showConfirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ¸…é™¤åå°†é‡æ–°åˆå§‹åŒ–å­¦ç”Ÿåå•', (result) => {
                    if (result) {
                        localStorage.removeItem('students');
                        localStorage.removeItem('scoreHistory');
                        showAlert('âš ï¸ æ•°æ®å·²æ¸…é™¤ï¼Œç³»ç»Ÿå°†é‡æ–°åˆå§‹åŒ–', true);
                        setTimeout(() => location.reload(), 2000);
                    }
                });
            };

            // å…ˆéªŒè¯å¯†ç 
            showVerifyPasswordModal(
                'clear',
                'æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œè¯·è¾“å…¥ç³»ç»Ÿå¯†ç ç¡®è®¤èº«ä»½',
                verifyAndClear
            );
        };

        // æ·»åŠ æ˜¾ç¤ºå†å²è®°å½•å‡½æ•°
        window.showHistory = (studentId) => {
            const students = JSON.parse(localStorage.getItem('students'));
            const student = students.find(s => s.id === studentId);
            const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];
            const studentHistory = history
                .filter(h => h.studentId === studentId)
                .reverse();

            const modal = document.getElementById('historyModal');
            const title = document.getElementById('historyTitle');
            const content = document.getElementById('historyContent');

            title.textContent = `${student.name} çš„ç§¯åˆ†å†å²è®°å½•`;
            content.innerHTML = studentHistory.length ? 
                studentHistory.map(h => `
                    <div class="history-item">
                        ${h.timestamp}: 
                        ${h.operation === 'add' ? 'åŠ ' : 'å‡'}${h.value}åˆ†
                        ï¼ˆ${h.oldScore} â†’ ${h.newScore}ï¼‰
                    </div>
                `).join('') :
                '<div class="history-item">æš‚æ— å†å²è®°å½•</div>';

            modal.style.display = 'flex';
        };

        // æ·»åŠ å…³é—­å†å²è®°å½•å¼¹çª—å‡½æ•°
        window.closeHistoryModal = () => {
            document.getElementById('historyModal').style.display = 'none';
        };

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        window.onclick = (event) => {
            const modal = document.getElementById('historyModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        // æ·»åŠ æ›´æ–°æ’è¡Œæ¦œå‡½æ•°
        const updateLeaderboard = (students) => {
            const topStudents = [...students]
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);

            // æ›´æ–°å›ºå®šæ’è¡Œæ¦œ
            const rankingList = document.getElementById('rankingList');
            updateRankingContent(rankingList, topStudents);

            // æ›´æ–°ç§»åŠ¨ç«¯æ’è¡Œæ¦œ
            const mobileRankingList = document.getElementById('mobileRankingList');
            updateRankingContent(mobileRankingList, topStudents);
        };

        // æ·»åŠ æ’è¡Œæ¦œå†…å®¹æ›´æ–°å‡½æ•°
        const updateRankingContent = (container, students) => {
            if (!container) return;
            
            container.innerHTML = students.map((student, index) => {
                const rankNumber = index + 1;
                const crown = rankNumber <= 3 ? 'ğŸ‘‘' : '';
                const scoreColorClass = getScoreColorClass(student.score);
                return `
                    <div class="rank-item rank-${rankNumber}">
                        <div class="rank-number">${rankNumber}</div>
                        <div class="rank-name">${student.name.replace(/^\d+\./, '')}</div>
                        <div class="rank-score ${scoreColorClass}">${student.score}</div>
                        <div class="rank-crown">${crown}</div>
                    </div>
                `;
            }).join('');
        };

        // ä¿®æ”¹ç§¯åˆ†ç¬¦å·è½¬æ¢å‡½æ•°ï¼Œä½¿ç”¨æ–°çš„å¤ªé˜³å›¾æ ‡
        const convertScoreToSymbols = (score) => {
            const symbols = {
                text: '',
                html: ''
            };
            
            // è®¡ç®—å¤ªé˜³æ•°é‡ï¼ˆ100åˆ†ä¸€ä¸ªï¼‰
            const suns = Math.floor(score / 100);
            const remainingAfterSuns = score % 100;
            
            // è®¡ç®—æœˆäº®æ•°é‡ï¼ˆ10åˆ†ä¸€ä¸ªï¼‰
            const moons = Math.floor(remainingAfterSuns / 10);
            const remainingAfterMoons = remainingAfterSuns % 10;
            
            // è®¡ç®—æ˜Ÿæ˜Ÿæ•°é‡ï¼ˆ1åˆ†ä¸€ä¸ªï¼‰
            const stars = remainingAfterMoons;
            
            // ç”Ÿæˆæ˜¾ç¤ºæ–‡æœ¬
            let textParts = [];
            if (suns > 0) textParts.push(`${suns}ğŸŒ`);  // ä½¿ç”¨å½©è‰²å¤ªé˜³è¡¨æƒ…
            if (moons > 0) textParts.push(`${moons}ğŸŒ™`);
            if (stars > 0) textParts.push(`${stars}â­`);
            symbols.text = textParts.join(' ');
            
            // ç”ŸæˆHTML - æ¯ä¸ªç¬¦å·ç‹¬ç«‹å æ®ä¸€ä¸ªæ ¼å­
            let htmlParts = [];
            for (let i = 0; i < suns; i++) {
                htmlParts.push(`<span class="sun">ğŸŒ</span>`);  // ä½¿ç”¨å½©è‰²å¤ªé˜³è¡¨æƒ…
            }
            for (let i = 0; i < moons; i++) {
                htmlParts.push(`<span class="moon">ğŸŒ™</span>`);
            }
            for (let i = 0; i < stars; i++) {
                htmlParts.push(`<span class="star">â­</span>`);
            }
            symbols.html = htmlParts.join('');
            
            return symbols;
        };

        // ä¿®å¤ updateDisplay å‡½æ•°
        const updateDisplay = (students) => {
            const container = document.getElementById('studentContainer');
            container.innerHTML = '';
            
            // æ˜¾ç¤ºå­¦ç”Ÿå¡ç‰‡
            students.forEach((student, index) => {
                const symbols = convertScoreToSymbols(student.score);
                const scoreColorClass = getScoreColorClass(student.score);
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <div class="delete-student-btn" onclick="deleteStudent(${student.id})" title="åˆ é™¤å­¦ç”Ÿ">Ã—</div>
                    <div class="student-name" onclick="editName(${student.id})">${(index + 1) + '.' + student.name.replace(/^\d+\./, '')}</div>
                    <div class="score-display">
                        <div class="total-score ${scoreColorClass}">ç§¯åˆ†ï¼š${student.score}</div>
                        <div class="score-symbol" title="${symbols.text}">${symbols.html}</div>
                    </div>
                    <input type="number" 
                           class="score-input" 
                           id="input-${student.id}" 
                           min="0" 
                           value="1"
                           aria-label="åˆ†æ•°å€¼">
                    <div class="button-group">
                        <button class="add-btn" onclick="updateScore(${student.id}, 'add')">+ åŠ åˆ†</button>
                        <button class="subtract-btn" onclick="updateScore(${student.id}, 'subtract')">- å‡åˆ†</button>
                    </div>
                    <button class="history-btn" onclick="showHistory(${student.id})">æŸ¥çœ‹å†å²è®°å½•</button>
                `;
                container.appendChild(card);
            });

            // æ·»åŠ æ–°å¢å­¦ç”Ÿå¡ç‰‡
            const addCard = document.createElement('div');
            addCard.className = 'student-card add-student-card';
            addCard.onclick = showAddStudentModal;
            addCard.innerHTML = `
                <div class="add-icon">+</div>
            `;
            container.appendChild(addCard);

            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard(students);
        };

        // ä¿®å¤å†å²è®°å½•å­˜å‚¨å‡½æ•°
        const addHistory = (studentId, operation, value, oldScore, newScore) => {
            const students = JSON.parse(localStorage.getItem('students'));
            const student = students.find(s => s.id === studentId);
            const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];
            
            history.push({
                studentId,
                studentName: student.name,
                operation,
                value,
                oldScore,
                newScore,
                timestamp: new Date().toLocaleString()
            });
            
            // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
            if (history.length > 100) history.shift();
            localStorage.setItem('scoreHistory', JSON.stringify(history));
        };

        // æ·»åŠ é”å®šç›¸å…³å˜é‡å’Œå‡½æ•°
        let isLocked = false;
        let UNLOCK_PASSWORD = '2020503';

        // åˆ‡æ¢é”å®šçŠ¶æ€
        window.toggleLock = () => {
            if (!isLocked) {
                // é”å®šç³»ç»Ÿ
                isLocked = true;
                updateLockState();
            } else {
                // æ˜¾ç¤ºå¯†ç å¼¹çª—
                showPasswordModal();
            }
        };

        // æ·»åŠ å¯†ç å¼¹çª—ç›¸å…³å‡½æ•°
        function showPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const input = document.getElementById('passwordInput');
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function submitPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === UNLOCK_PASSWORD) {
                isLocked = false;
                updateLockState();
                closePasswordModal();
            } else {
                showAlert('å¯†ç é”™è¯¯ï¼');
            }
        }

        // æ·»åŠ å›è½¦é”®æäº¤å¯†ç åŠŸèƒ½
        document.getElementById('passwordInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitPassword();
            }
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('passwordModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closePasswordModal();
            }
        });

        // æ›´æ–°é”å®šçŠ¶æ€UI
        const updateLockState = () => {
            const lockBtn = document.querySelector('.lock-btn');
            const controls = document.querySelectorAll('.controls button:not(.lock-btn), .student-card button, .student-card input, .student-name');
            
            if (isLocked) {
                lockBtn.textContent = 'ç³»ç»Ÿå·²é”å®š';
                lockBtn.classList.add('locked');
                controls.forEach(el => el.classList.add('disabled'));
            } else {
                lockBtn.textContent = 'ç³»ç»Ÿæœªé”å®š';
                lockBtn.classList.remove('locked');
                controls.forEach(el => el.classList.remove('disabled'));
            }
        };

        // ä¿®æ”¹æ‰€æœ‰æ“ä½œå‡½æ•°ï¼Œæ·»åŠ é”å®šæ£€æŸ¥
        const checkLock = (callback) => {
            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return false;
            }
            return callback();
        };

        // æ·»åŠ è‡ªå®šä¹‰å¼¹çª—ç›¸å…³å‡½æ•°
        let confirmCallback = null;

        function showAlert(message, isWarning = false) {
            const modal = document.getElementById('alertModal');
            const content = document.getElementById('alertContent');
            const alertClass = isWarning ? 'warning' : '';
            
            // æ·»åŠ æˆ–ç§»é™¤ warning ç±»
            modal.className = `modal-base system-alert ${alertClass}`;
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ ‡é¢˜
            const title = modal.querySelector('.modal-title');
            title.textContent = isWarning ? 'ç³»ç»Ÿè­¦å‘Š' : 'ç³»ç»Ÿæç¤º';
            
            // è®¾ç½®æ¶ˆæ¯å†…å®¹
            content.textContent = message;
            modal.style.display = 'flex';
        }

        function closeAlertModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        function showConfirm(message, callback) {
            const modal = document.getElementById('confirmModal');
            const content = document.getElementById('confirmContent');
            content.textContent = message;
            confirmCallback = callback;
            modal.style.display = 'flex';
        }

        function handleConfirm(result) {
            document.getElementById('confirmModal').style.display = 'none';
            if (confirmCallback) {
                confirmCallback(result);
                confirmCallback = null;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const students = initializeStudents();
            updateDisplay(students);
            // ä»localStorageè¯»å–ä¿å­˜çš„å¯†ç 
            const savedPassword = localStorage.getItem('systemPassword');
            const savedAdminPassword = localStorage.getItem('adminPassword');
            if (savedPassword) {
                UNLOCK_PASSWORD = savedPassword;
            }
            if (savedAdminPassword) {
                ADMIN_PASSWORD = savedAdminPassword;
            }
            updateAdminUI();
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal-base');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modal.id === 'nameEditModal') {
                        currentEditingId = null;
                    }
                }
            });
        });

        // ä¿®æ”¹åˆ†æ•°é¢œè‰²åŒºé—´å‡½æ•°
        const getScoreColorClass = (score) => {
            if (score >= 500) return 'score-500-1000';
            if (score >= 100) return 'score-100-500';
            return 'score-0-100';
        };

        // æ·»åŠ äºŒç»´ç ç›¸å…³å‡½æ•°
        let qrcode = null;
        
        function showQRCode() {
            const modal = document.getElementById('qrModal');
            modal.style.display = 'flex';
            
            if (!qrcode) {
                // è·å–å½“å‰é¡µé¢URL
                const currentURL = window.location.href;
                
                // åˆ›å»ºäºŒç»´ç 
                qrcode = new QRCode("qrcode", {
                    text: currentURL,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.querySelector('.qr-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeQRModal();
            }
        });

        // æ·»åŠ ä¿®æ”¹å¯†ç ç›¸å…³å‡½æ•°
        function showChangePasswordModal(isForced = false) {
            if (isLocked && !isForced) {
                showAlert('è¯·å…ˆè§£é”ç³»ç»Ÿå†ä¿®æ”¹å¯†ç ï¼');
                return;
            }
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'flex';
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            // å¦‚æœæ˜¯å¼ºåˆ¶ä¿®æ”¹å¯†ç ï¼Œç¦ç”¨å…³é—­æŒ‰é’®
            const closeBtn = modal.querySelector('.modal-close');
            const cancelBtn = modal.querySelector('.modal-btn-secondary');
            if (isForced) {
                closeBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                modal.setAttribute('data-forced', 'true');
            } else {
                closeBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                modal.removeAttribute('data-forced');
            }
        }

        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal.getAttribute('data-forced') === 'true') {
                showAlert('é¦–æ¬¡ç™»å½•å¿…é¡»ä¿®æ”¹é»˜è®¤å¯†ç ï¼');
                return;
            }
            modal.style.display = 'none';
        }

        function submitChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µï¼');
                return;
            }

            if (oldPassword !== ADMIN_PASSWORD) {
                showAlert('åŸå¯†ç é”™è¯¯ï¼');
                return;
            }

            if (newPassword === 'admin888') {
                showAlert('æ–°å¯†ç ä¸èƒ½ä¸é»˜è®¤å¯†ç ç›¸åŒï¼');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }

            // æ›´æ–°ç®¡ç†å‘˜å¯†ç 
            ADMIN_PASSWORD = newPassword;
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('adminPassword', newPassword);
            
            // å…³é—­å¼¹çª—
            const modal = document.getElementById('changePasswordModal');
            modal.removeAttribute('data-forced');
            modal.style.display = 'none';
            
            showAlert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            resetAdminTimer();  // é‡ç½®ç®¡ç†å‘˜è®¡æ—¶å™¨
        }

        // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
        document.getElementById('confirmPassword').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitChangePassword();
            }
        });

        // æ·»åŠ å¯†ç éªŒè¯ç›¸å…³å˜é‡å’Œå‡½æ•°
        let currentOperation = null;
        let verifyCallback = null;

        function showVerifyPasswordModal(operation, message, callback) {
            const modal = document.getElementById('verifyPasswordModal');
            const messageElem = document.getElementById('verifyPasswordMessage');
            const input = document.getElementById('verifyPassword');
            
            currentOperation = operation;
            verifyCallback = callback;
            messageElem.textContent = message;
            
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
        }

        function closeVerifyPasswordModal() {
            document.getElementById('verifyPasswordModal').style.display = 'none';
            currentOperation = null;
            verifyCallback = null;
        }

        // ä¿®æ”¹å¯†ç éªŒè¯æäº¤å‡½æ•°
        function submitVerifyPassword() {
            const password = document.getElementById('verifyPassword').value;
            if (!password) {
                showAlert('è¯·è¾“å…¥å¯†ç ï¼');
                return;
            }
            
            if (password === UNLOCK_PASSWORD) {
                if (verifyCallback) {
                    const callback = verifyCallback;
                    closeVerifyPasswordModal();
                    callback();
                }
            } else {
                showAlert('å¯†ç é”™è¯¯ï¼');
            }
        }

        // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
        document.getElementById('verifyPassword').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitVerifyPassword();
            }
        });

        // æ·»åŠ ç‚¹å‡»å¤–éƒ¨å…³é—­éªŒè¯å¼¹çª—
        document.getElementById('verifyPasswordModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeVerifyPasswordModal();
            }
        });

        // æ·»åŠ æ–°å¢å­¦ç”Ÿç›¸å…³å‡½æ•°
        function showAddStudentModal() {
            if (!isAdmin) {
                showAlert('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }
            const modal = document.getElementById('addStudentModal');
            const input = document.getElementById('newStudentName');
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
            resetAdminTimer();
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
        }

        function submitAddStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            
            if (!name) {
                showAlert('è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼');
                return;
            }

            if (/\d/.test(name)) {
                showAlert('å§“åä¸èƒ½åŒ…å«æ•°å­—ï¼');
                return;
            }

            const students = JSON.parse(localStorage.getItem('students')) || [];
            const newId = students.length > 0 ? Math.max(...students.map(s => s.id)) + 1 : 1;
            
            students.push({
                id: newId,
                name: name,
                score: 0
            });

            localStorage.setItem('students', JSON.stringify(students));
            updateDisplay(students);
            closeAddStudentModal();
            showAlert('âœ… æ–°å¢å­¦ç”ŸæˆåŠŸï¼');
        }

        // æ·»åŠ åˆ é™¤å­¦ç”Ÿå‡½æ•°
        function deleteStudent(studentId) {
            if (!isAdmin) {
                showAlert('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­¦ç”Ÿå—ï¼Ÿç›¸å…³çš„ç§¯åˆ†è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ï¼', (result) => {
                if (result) {
                    const students = JSON.parse(localStorage.getItem('students'));
                    const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];
                    
                    // åˆ é™¤å­¦ç”Ÿ
                    const updatedStudents = students.filter(s => s.id !== studentId);
                    // åˆ é™¤ç›¸å…³å†å²è®°å½•
                    const updatedHistory = history.filter(h => h.studentId !== studentId);
                    
                    localStorage.setItem('students', JSON.stringify(updatedStudents));
                    localStorage.setItem('scoreHistory', JSON.stringify(updatedHistory));
                    
                    updateDisplay(updatedStudents);
                    showAlert('âœ… åˆ é™¤æˆåŠŸï¼');
                }
            });
        }

        // ä¿®æ”¹å¯¼å…¥å‡½æ•°ä¸­çš„æ•°æ®å¤„ç†
        window.importFromExcel = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // è¯»å–å­¦ç”Ÿæ•°æ®
                        const studentSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const studentData = XLSX.utils.sheet_to_json(studentSheet);
                        
                        // éªŒè¯åå­—æ ¼å¼
                        const invalidNames = studentData.filter(row => /\d/.test(row['å§“å']));
                        if (invalidNames.length > 0) {
                            showAlert('å¯¼å…¥å¤±è´¥ï¼šä»¥ä¸‹å­¦ç”Ÿå§“ååŒ…å«æ•°å­—ï¼š\n' + 
                                    invalidNames.map(row => row['å§“å']).join('\n'));
                            return;
                        }

                        // è½¬æ¢ä¸ºåº”ç”¨æ ¼å¼
                        const students = studentData.map((row, index) => ({
                            id: index + 1,
                            name: `${index + 1}.${row['å§“å']}`,
                            score: parseInt(row['ç§¯åˆ†']) || 0
                        }));

                        // ä¿å­˜æ•°æ®
                        localStorage.setItem('students', JSON.stringify(students));
                        updateDisplay(students);
                        showAlert('âœ… å¯¼å…¥æˆåŠŸï¼');

                    } catch (err) {
                        console.error(err);
                        showAlert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        };

        // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
        document.getElementById('newStudentName').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitAddStudent();
            }
        });

        // æ·»åŠ ç®¡ç†å‘˜ç›¸å…³å˜é‡
        let isAdmin = false;
        let ADMIN_PASSWORD = 'admin888';
        let adminTimer = null;

        // ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°ï¼Œæ·»åŠ ç®¡ç†å‘˜å¯†ç è¯»å–
        document.addEventListener('DOMContentLoaded', () => {
            const students = initializeStudents();
            updateDisplay(students);
            // ä»localStorageè¯»å–ä¿å­˜çš„å¯†ç 
            const savedPassword = localStorage.getItem('systemPassword');
            const savedAdminPassword = localStorage.getItem('adminPassword');
            if (savedPassword) {
                UNLOCK_PASSWORD = savedPassword;
            }
            if (savedAdminPassword) {
                ADMIN_PASSWORD = savedAdminPassword;
            }
            updateAdminUI();
        });

        // æ·»åŠ ç®¡ç†å‘˜ç™»å½•ç›¸å…³å‡½æ•°
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                if (adminTimer) {
                    clearTimeout(adminTimer);
                    adminTimer = null;
                }
                updateAdminUI();
                showAlert('å·²é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
            } else {
                showAdminLogin();
            }
        }

        function showAdminLogin() {
            const modal = document.getElementById('adminLoginModal');
            const input = document.getElementById('adminPassword');
            modal.style.display = 'flex';
            input.value = '';
            input.focus();
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
        }

        function submitAdminLogin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                updateAdminUI();
                closeAdminLogin();
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡ç™»å½•ï¼ˆä½¿ç”¨é»˜è®¤å¯†ç ï¼‰
                if (password === 'admin888') {
                    showAlert('é¦–æ¬¡ç™»å½•éœ€è¦ä¿®æ”¹å¯†ç ä»¥ä¿æŠ¤æ•°æ®å®‰å…¨ï¼');
                    setTimeout(() => {
                        showChangePasswordModal(true); // true è¡¨ç¤ºå¼ºåˆ¶ä¿®æ”¹å¯†ç 
                    }, 1500);
                } else {
                    showAlert('âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼');
                }
                resetAdminTimer();
            } else {
                showAlert('å¯†ç é”™è¯¯ï¼');
            }
        }

        // æ›´æ–°ç®¡ç†å‘˜UIçŠ¶æ€
        function updateAdminUI() {
            const adminBtn = document.querySelector('.admin-btn');
            adminBtn.textContent = isAdmin ? 'é€€å‡ºç®¡ç†å‘˜' : 'ç®¡ç†å‘˜ç™»å½•';
            document.body.classList.toggle('admin-mode', isAdmin);
        }

        // ä¿®æ”¹æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œå‡½æ•°ï¼Œæ·»åŠ ç®¡ç†å‘˜æ£€æŸ¥
        const checkAdmin = (callback) => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return false;
            }
            callback(); // ç›´æ¥æ‰§è¡Œå›è°ƒï¼Œä¸å†è¿”å›å€¼
        };

        // ä¿®æ”¹ç›¸å…³æ“ä½œå‡½æ•°çš„å®šä¹‰æ–¹å¼
        window.clearStorage = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }
            
            showConfirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ¸…é™¤åå°†é‡æ–°åˆå§‹åŒ–å­¦ç”Ÿåå•', (result) => {
                if (result) {
                    localStorage.removeItem('students');
                    localStorage.removeItem('scoreHistory');
                    showAlert('âš ï¸ æ•°æ®å·²æ¸…é™¤ï¼Œç³»ç»Ÿå°†é‡æ–°åˆå§‹åŒ–', true);
                    setTimeout(() => location.reload(), 2000);
                }
            });
        };

        window.resetAllScores = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }

            showConfirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å­¦ç”Ÿçš„ç§¯åˆ†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼', (result) => {
                if (result) {
                    const students = JSON.parse(localStorage.getItem('students'));
                    const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];
                    
                    students.forEach(student => {
                        if (student.score > 0) {
                            history.push({
                                studentId: student.id,
                                studentName: student.name,
                                operation: 'reset',
                                value: student.score,
                                oldScore: student.score,
                                newScore: 0,
                                timestamp: new Date().toLocaleString()
                            });
                            student.score = 0;
                        }
                    });
                    
                    localStorage.setItem('students', JSON.stringify(students));
                    localStorage.setItem('scoreHistory', JSON.stringify(history));
                    updateDisplay(students);
                    showAlert('âœ… æ‰€æœ‰å­¦ç”Ÿç§¯åˆ†å·²é‡ç½®ä¸º0', false);
                }
            });
        };

        window.exportToExcel = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            const students = JSON.parse(localStorage.getItem('students'));
            const history = JSON.parse(localStorage.getItem('scoreHistory')) || [];

            // å‡†å¤‡å­¦ç”Ÿæ•°æ®å·¥ä½œè¡¨
            const studentData = students.map(s => ({
                'åºå·': s.id,
                'å§“å': s.name.replace(/^\d+\./, ''),
                'ç§¯åˆ†': s.score
            }));

            // å‡†å¤‡å†å²è®°å½•å·¥ä½œè¡¨
            const historyData = history.map(h => ({
                'æ—¶é—´': h.timestamp,
                'å­¦ç”Ÿ': h.studentName.replace(/^\d+\./, ''),
                'æ“ä½œ': h.operation === 'add' ? 'åŠ åˆ†' : h.operation === 'subtract' ? 'å‡åˆ†' : 'é‡ç½®',
                'åˆ†å€¼': h.value,
                'å˜æ›´å‰ç§¯åˆ†': h.oldScore,
                'å˜æ›´åç§¯åˆ†': h.newScore
            }));

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // æ·»åŠ å·¥ä½œè¡¨
            const ws1 = XLSX.utils.json_to_sheet(studentData);
            const ws2 = XLSX.utils.json_to_sheet(historyData);
            XLSX.utils.book_append_sheet(wb, ws1, "å­¦ç”Ÿç§¯åˆ†");
            XLSX.utils.book_append_sheet(wb, ws2, "å†å²è®°å½•");

            // å¯¼å‡ºExcelæ–‡ä»¶
            XLSX.writeFile(wb, `ç§¯åˆ†æ•°æ®_${new Date().toLocaleDateString()}.xlsx`);
        };

        window.importFromExcel = () => {
            if (!isAdmin) {
                showAlert('æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }

            if (isLocked) {
                showAlert('ç³»ç»Ÿå·²é”å®šï¼Œè¯·å…ˆè§£é”ï¼');
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        const studentSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const studentData = XLSX.utils.sheet_to_json(studentSheet);
                        
                        const invalidNames = studentData.filter(row => /\d/.test(row['å§“å']));
                        if (invalidNames.length > 0) {
                            showAlert('å¯¼å…¥å¤±è´¥ï¼šä»¥ä¸‹å­¦ç”Ÿå§“ååŒ…å«æ•°å­—ï¼š\n' + 
                                    invalidNames.map(row => row['å§“å']).join('\n'));
                            return;
                        }

                        const students = studentData.map((row, index) => ({
                            id: index + 1,
                            name: `${index + 1}.${row['å§“å']}`,
                            score: parseInt(row['ç§¯åˆ†']) || 0
                        }));

                        localStorage.setItem('students', JSON.stringify(students));
                        updateDisplay(students);
                        showAlert('âœ… å¯¼å…¥æˆåŠŸï¼');
                    } catch (err) {
                        console.error(err);
                        showAlert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        };

        // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
        document.getElementById('adminPassword').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitAdminLogin();
            }
        });

        // ä¿®æ”¹å¯†ç ä¿®æ”¹å‡½æ•°ï¼ŒåŠ å…¥ç®¡ç†å‘˜å¯†ç ä¿®æ”¹åŠŸèƒ½
        function submitChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µï¼');
                return;
            }

            if (oldPassword !== ADMIN_PASSWORD) {
                showAlert('åŸå¯†ç é”™è¯¯ï¼');
                return;
            }

            if (newPassword === 'admin888') {
                showAlert('æ–°å¯†ç ä¸èƒ½ä¸é»˜è®¤å¯†ç ç›¸åŒï¼');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }

            // æ›´æ–°ç®¡ç†å‘˜å¯†ç 
            ADMIN_PASSWORD = newPassword;
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('adminPassword', newPassword);
            showAlert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            closeChangePasswordModal();
        }

        // æ·»åŠ ç®¡ç†å‘˜è‡ªåŠ¨é€€å‡ºåŠŸèƒ½
        function resetAdminTimer() {
            if (adminTimer) {
                clearTimeout(adminTimer);
            }
            if (isAdmin) {
                adminTimer = setTimeout(() => {
                    if (isAdmin) {
                        isAdmin = false;
                        updateAdminUI();
                        showAlert('ç”±äºé•¿æ—¶é—´æœªæ“ä½œï¼Œå·²è‡ªåŠ¨é€€å‡ºç®¡ç†å‘˜æ¨¡å¼');
                    }
                }, 5 * 60 * 1000); // 5åˆ†é’Ÿ
            }
        }

        // æ·»åŠ ç”¨æˆ·æ“ä½œç›‘å¬
        document.addEventListener('mousemove', resetAdminTimer);
        document.addEventListener('keydown', resetAdminTimer);
        document.addEventListener('click', resetAdminTimer);

        // åˆå§‹åŒ–æ—¶æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å®šæ—¶å™¨
        document.addEventListener('DOMContentLoaded', () => {
            if (adminTimer) {
                clearTimeout(adminTimer);
                adminTimer = null;
            }
            // ...existing initialization code...
        });

        // æ·»åŠ å¤„ç†ä¿®æ”¹å¯†ç çš„å‡½æ•°
        function handleChangePassword() {
            if (!isAdmin) {
                showAlert('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼');
                return;
            }
            
            if (isLocked) {
                showAlert('è¯·å…ˆè§£é”ç³»ç»Ÿå†ä¿®æ”¹å¯†ç ï¼');
                return;
            }

            const modal = document.getElementById('changePasswordModal');
            const oldPasswordInput = document.getElementById('oldPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            oldPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            
            // æ˜¾ç¤ºå¼¹çª—
            modal.style.display = 'flex';
            oldPasswordInput.focus();
        }

        // ä¿®æ”¹å…³é—­ä¿®æ”¹å¯†ç å¼¹çª—çš„å‡½æ•°
        function closeChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal.getAttribute('data-forced') === 'true') {
                showAlert('é¦–æ¬¡ç™»å½•å¿…é¡»ä¿®æ”¹é»˜è®¤å¯†ç ï¼');
                return;
            }
            modal.style.display = 'none';
        }

        // ä¿®æ”¹æäº¤å¯†ç ä¿®æ”¹çš„å‡½æ•°
        function submitChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showAlert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µï¼');
                return;
            }

            if (oldPassword !== ADMIN_PASSWORD) {
                showAlert('åŸå¯†ç é”™è¯¯ï¼');
                return;
            }

            if (newPassword === 'admin888') {
                showAlert('æ–°å¯†ç ä¸èƒ½ä¸é»˜è®¤å¯†ç ç›¸åŒï¼');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }

            // æ›´æ–°ç®¡ç†å‘˜å¯†ç 
            ADMIN_PASSWORD = newPassword;
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('adminPassword', newPassword);
            
            // å…³é—­å¼¹çª—
            const modal = document.getElementById('changePasswordModal');
            modal.removeAttribute('data-forced');
            modal.style.display = 'none';
            
            showAlert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            resetAdminTimer();  // é‡ç½®ç®¡ç†å‘˜è®¡æ—¶å™¨
        }

        // æ·»åŠ å›è½¦é”®æäº¤æ”¯æŒ
        document.getElementById('confirmPassword').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                submitChangePassword();
            }
        });
    </script>
</body>
</html>